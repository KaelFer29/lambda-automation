name: CI/CD Lambda (Container)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  TF_INPUT: "false"

jobs:
  deploy:
    name: Build Image + Plan/Apply Lambda
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: gha-opentofu

      - name: Init & Validate
        working-directory: infra
        run: |
          tofu init
          tofu validate

      - name: Apply base infra (ECR)
        if: github.event_name == push
        working-directory: infra
        run: |
          tofu apply -auto-approve -no-color

      - name: Get ECR repo URL
        id: ecr
        run: |
          REPO_NAME="dte-fetcher-lambda"
          REPO_URL=$(aws ecr describe-repositories --repository-names "$REPO_NAME" --query repositories[0].repositoryUri --output text)
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT

      - name: Login to ECR
        if: github.event_name == push
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.ecr.outputs.repo_url }}

      - name: Build & Push image
        if: github.event_name == push
        run: |
          IMAGE_TAG=${GITHUB_SHA}
          docker build -t ${{ steps.ecr.outputs.repo_url }}:$IMAGE_TAG .
          docker push ${{ steps.ecr.outputs.repo_url }}:$IMAGE_TAG
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Plan with image_tag
        if: github.event_name == push
        working-directory: infra
        run: |
          tofu plan -var "image_tag=${{ steps.deploy.outputs.image_tag }}" -no-color

      - name: Apply with image_tag
        if: github.event_name == push
        working-directory: infra
        run: |
          tofu apply -auto-approve -var "image_tag=${{ steps.deploy.outputs.image_tag }}"

      - name: Plan (PR) - read-only
        if: github.event_name == pull_request
        working-directory: infra
        run: |
          tofu plan -no-color
